<!doctype html>
<html>

<head>
    <title>XIAO-Sense</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <style>
        html,
        body {
            padding: 0;
            margin: 0;
            background-color: black;
        }

        p {
            padding-left: 6px;
        }

        .wrapper {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 5px;
        }

        .min-width-200px {
            min-width: 200px;
        }
    </style>

    <script>
        const BAS_ID = 0x180F; // Battery Service 
        const ESS_ID = 0x181A; // Environmental Sensing Service
        const AIOS_ID = 0x1815; // Automation IO Service
        const UUID_BAS_BATTERY_LEVEL = 0x2a19; // Battery Level Characteristic
        const UUID_TEMPERATURE = 0x2a6e; // Temperature Characteristic
        const UUID_PRESSURE = 0x2a6d; // Pressure Characteristic
        const UUID_HUMIDITY = 0x2a6f; // Humidity Characteristic
        const UUID_GATT_DO = 0x2a57; // Digital Output Characteristic

        const IO_MASK_0 = 0x01;
        const IO_MASK_1 = 0x04;
        const IO_MASK_2 = 0x10;

        let device = null;
        let digitalOutputChar = null;
        let digitalOutputState = 0;

        const readInt16Value = (value) => {
            const b0 = value.getUint8(0);
            const b1 = value.getUint8(1);
            return ((b1 << 8) | b0) - (b1 & 0x80 ? 65536 : 0);
        }

        const updateCharUint8Value = (id, symbol, value) => {
            const val = value.getUint8(0);
            document.getElementById(id).innerHTML = `${val}${symbol}`;
        }

        const updateCharInt16Value = (id, symbol, value, pow, map = (v) => v) => {
            const val = map(readInt16Value(value));
            document.getElementById(id).innerHTML = `${(val * (10 ** pow)).toFixed(-pow)}${symbol}`;
        }

        const manageCharacteristic = async (service, charId, onValue) => {
            const characteristic = await service.getCharacteristic(charId);
            const value = await characteristic.readValue();
            onValue(value);
            await characteristic.startNotifications();
            characteristic.addEventListener('characteristicvaluechanged',
                (event) => onValue(event.target.value));
        }

        // https://en.wikipedia.org/wiki/Pressure_altitude
        const adjustPressure = (pressure) => {
            const altitude = Number(document.getElementById('altitude').value) ?? 0;
            const offset = (1013.25 - 1013.25 * Math.E ** (-altitude / 8431));
            return pressure + offset;
        }

        const requestDevice = async () => {
            if (device) return;
            try {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{
                        name: 'XIAO-SENSE',
                        services: [BAS_ID, ESS_ID, AIOS_ID],
                    }]
                });
                device.addEventListener('gattserverdisconnected', onDisconnected);
                updateButtons();

                const server = await device.gatt.connect();

                const bas = await server.getPrimaryService(BAS_ID);
                manageCharacteristic(bas, UUID_BAS_BATTERY_LEVEL, (value) => updateCharUint8Value('battery_level', '%', value));

                const ess = await server.getPrimaryService(ESS_ID);
                manageCharacteristic(ess, UUID_TEMPERATURE, (value) => updateCharInt16Value('temperature', 'C', value, -2));
                manageCharacteristic(ess, UUID_HUMIDITY, (value) => updateCharInt16Value('hymidity', '%', value, -2));
                manageCharacteristic(ess, UUID_PRESSURE, (value) => updateCharInt16Value('pressure', 'hPa', value, 0, adjustPressure));

                const aios = await server.getPrimaryService(AIOS_ID);
                digitalOutputChar = await aios.getCharacteristic(UUID_GATT_DO);
                const value = await digitalOutputChar.readValue();
                digitalOutputState = value.getUint8(0);
                updateLedButtons();
            } catch (e) {
                console.error(e);
                disconnect();
            }
        }

        const disconnect = () => {
            if (!device) return;
            try {
                device.gatt.disconnect();
            } catch (e) {
                console.error(e);
            }
        }

        const onDisconnected = () => {
            device = null;
            digitalOutputChar = null;
            updateButtons();
        }

        const updateButtons = () => {
            if (device) {
                document.getElementById('btn_connect').classList.add('hide');
                document.getElementById('btn_disconnect').classList.remove('hide');
            } else {
                document.getElementById('btn_disconnect').classList.add('hide');
                document.getElementById('btn_connect').classList.remove('hide');
            }
        }

        const updateLedButton = (id, color, mask) => {
            if (digitalOutputState & mask) {
                document.getElementById(id).classList.add(color);
                document.getElementById(id).classList.remove('grey');
            } else {
                document.getElementById(id).classList.add('grey');
                document.getElementById(id).classList.remove(color);
            }
        }

        const updateLedButtons = () => {
            updateLedButton('btn_led_red', 'red', IO_MASK_0);
            updateLedButton('btn_led_green', 'green', IO_MASK_1);
            updateLedButton('btn_led_blue', 'blue', IO_MASK_2);
        }

        const toggleDigitalOutput = async (mask) => {
            if (!digitalOutputChar) return;
            const state = digitalOutputState ^ mask;
            const buff = new Uint8Array([state]);
            try {
                await digitalOutputChar.writeValue(buff);
                digitalOutputState = state;
                updateLedButtons();
            } catch (e) {
                console.error(e);
            }
        }
    </script>
</head>

<body>
    <div class="wrapper card blue-grey darken-1 white-text">
        <div class="card-content min-width-200px">
            <span class="card-title center">XIAO-Sense</span>
            <div class="valign-wrapper">
                <i class="material-icons white-text">battery_std</i>
                <p class="orange-text">
                    Battery Level <span class="white-text right-align" id="battery_level"></span></p>
            </div>
            <div class="valign-wrapper">
                <i class="material-icons white-text">beach_access</i>
                <p class="orange-text">
                    Temperature <span class="white-text" id="temperature"></span></p>
            </div>
            <div class="valign-wrapper">
                <i class="material-icons white-text">invert_colors</i>
                <p class="orange-text">
                    Humidity <span class="white-text" id="hymidity"></span></p>
            </div>
            <div class="valign-wrapper">
                <i class="material-icons white-text">cloud</i>
                <p class="orange-text">
                    Pressure <span class="white-text" id="pressure"></span></p>
            </div>
            <div class="input-field">
                <textarea id="altitude" class="materialize-textarea white-text"
                    oninput="this.value = this.value.replace(/[^0-9]/g, '');"></textarea>
                <label for="altitude">Altitude in meters</label>
            </div>
            <div class="valign-wrapper">
                <p>
                    <button id="btn_led_red" class="btn-floating grey"
                        onclick="toggleDigitalOutput(IO_MASK_0)">R</button>
                </p>
                <p>
                    <button id="btn_led_green" class="btn-floating grey"
                        onclick="toggleDigitalOutput(IO_MASK_1)">G</button>
                </p>
                <p>
                    <button id="btn_led_blue" class="btn-floating grey"
                        onclick="toggleDigitalOutput(IO_MASK_2)">B</button>
                </p>
            </div>
        </div>
        <div class="card-action center">
            <button id="btn_connect" class="btn blue" onclick="requestDevice()">Request Device</button>
            <button id="btn_disconnect" class="btn red hide" onclick="disconnect()">Disconnect</button>
        </div>
    </div>
</body>

</html>