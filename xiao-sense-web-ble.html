<!doctype html>
<html>

<head>
    <title>XIAO-Sense</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        html,
        body {
            padding: 0;
            margin: 0;
            background-color: black;
        }

        p {
            padding-left: 6px;
        }

        .wrapper {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 5px;
        }
    </style>

    <script>
        const BAS_ID = 0x180F; // Battery Service 
        const ESS_ID = 0x181A; // Environmental Sensing Service
        const UUID_BAS_BATTERY_LEVEL = 0x2a19; // Battery Level Characteristic
        const UUID_TEMPERATURE = 0x2a6e; // Temperature Characteristic
        const UUID_PRESSURE = 0x2a6d; // Pressure Characteristic
        const UUID_HUMIDITY = 0x2a6f; // Humidity Characteristic

        let device = null;

        const readInt16Value = (value) => {
            const b0 = value.getUint8(0);
            const b1 = value.getUint8(1);
            return ((b1 << 8) | b0) * (b1 & 0x80 ? -1 : 1);
        }

        const updateCharUint8Value = (id, symbol, value) => {
            const val = value.getUint8(0);
            document.getElementById(id).innerHTML = `${val}${symbol}`;
        }

        const updateCharInt16Value = (id, symbol, value, pow) => {
            const val = readInt16Value(value);
            document.getElementById(id).innerHTML = `${(val * (10 ** pow)).toFixed(-pow)}${symbol}`;
        }

        const manageCharacteristic = async (service, charId, onValue) => {
            const characteristic = await service.getCharacteristic(charId);
            const value = await characteristic.readValue();
            onValue(value);
            await characteristic.startNotifications();
            characteristic.addEventListener('characteristicvaluechanged',
                (event) => onValue(event.target.value));
        }

        const requestDevice = async () => {
            if (device) return;
            try {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [BAS_ID, ESS_ID] }]
                });
                const server = await device.gatt.connect();
                updateButtons();
                const bas = await server.getPrimaryService(BAS_ID);
                manageCharacteristic(bas, UUID_BAS_BATTERY_LEVEL, (value) => updateCharUint8Value('battery_level', '%', value));
                const ess = await server.getPrimaryService(ESS_ID);
                manageCharacteristic(ess, UUID_TEMPERATURE, (value) => updateCharInt16Value('temperature', 'C', value, -2));
                manageCharacteristic(ess, UUID_HUMIDITY, (value) => updateCharInt16Value('hymidity', '%', value, -2));
                manageCharacteristic(ess, UUID_PRESSURE, (value) => updateCharInt16Value('pressure', 'hPa', value, 0));
            } catch (e) {
                disconnect();
            }
        }

        const disconnect = () => {
            if (!device) return;
            try {
                device.gatt.disconnect();
            } catch (e) { }
            device = null;
            updateButtons();
        }

        const updateButtons = () => {
            if (device) {
                document.getElementById('btn_connect').classList.add('hide');
                document.getElementById('btn_disconnect').classList.remove('hide');
            } else {
                document.getElementById('btn_disconnect').classList.add('hide');
                document.getElementById('btn_connect').classList.remove('hide');
            }
        }
    </script>
</head>

<body>
    <div class="wrapper card blue-grey darken-1 white-text">
        <div class="card-content">
            <span class="card-title center">XIAO-Sense</span>
            <div class="valign-wrapper">
                <i class="material-icons white-text">battery_std</i>
                <p class="orange-text">
                    Battery Level <span class="white-text right-align" id="battery_level"></span></p>
            </div>
            <div class="valign-wrapper">
                <i class="material-icons white-text">beach_access</i>
                <p class="orange-text">
                    Temperature <span class="white-text right-align" id="temperature"></span></p>
            </div>
            <div class="valign-wrapper">
                <i class="material-icons white-text">invert_colors</i>
                <p class="orange-text">
                    Humidity <span class="white-text right-align" id="hymidity"></span></p>
            </div>
            <div class="valign-wrapper">
                <i class="material-icons white-text">cloud</i>
                <p class="orange-text">
                    Pressure <span class="white-text right-align" id="pressure"></span></p>
            </div>
        </div>
        <div class="card-action center">
            <button id="btn_connect" class="btn blue" onclick="requestDevice()">Request Device</button>
            <button id="btn_disconnect" class="btn red hide" onclick="disconnect()">Disconnect</button>
        </div>
    </div>
</body>

</html>